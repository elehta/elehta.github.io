<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

  :root { --bg: #3f4146; --surface: #484b51; --surface2: #52555c; --border: #6b6f78; --accent: #00c98a; --danger: #ff3d5a; --warn: #ffb800; --muted: #c0c4cc; --text: #f0f2f5; --text-dim: #d0d4dc; --mono: 'Space Mono', monospace; --sans: 'Plus Jakarta Sans', sans-serif; }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); font-size: 17px; line-height: 1.6; }
  #dpp-root { max-width: 860px; margin: 0 auto; padding-top: 60px; padding-bottom: 30px; padding-left: 16px; padding-right: 16px; }

  .dpp-header { display: grid; grid-template-columns: 1fr auto; align-items: start; gap: 20px; padding-bottom: 24px; border-bottom: 1px solid var(--border); margin-bottom: 28px; animation: fadeDown 0.4s ease both; }
  .dpp-eyebrow { font-family: var(--mono); font-size: 0.78rem; letter-spacing: 0.2em; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
  .dpp-title { font-size: 2.4rem; font-weight: 800; line-height: 1.1; letter-spacing: -0.01em; text-transform: uppercase; color: #fff; }
  .dpp-subtitle { font-family: var(--mono); font-size: 0.78rem; color: var(--text-dim); margin-top: 10px; word-break: break-all; }
  .dpp-image { width: 120px; height: 120px; object-fit: cover; border: 1px solid var(--border); filter: grayscale(20%); }

  .meta-strip { display: flex; gap: 0; margin-bottom: 28px; border: 1px solid var(--border); overflow: hidden; animation: fadeUp 0.4s 0.1s ease both; }
  .meta-cell { flex: 1; padding: 12px 16px; border-right: 1px solid var(--border); }
  .meta-cell:last-child { border-right: none; }
  .meta-cell-label { font-family: var(--mono); font-size: 0.68rem; letter-spacing: 0.15em; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
  .meta-cell-value { font-size: 1.05rem; font-weight: 600; color: var(--text); }

  .section { margin-bottom: 20px; border: 1px solid var(--border); background: var(--surface); animation: fadeUp 0.4s ease both; }
  .section-header { display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: var(--surface2); border-bottom: 1px solid var(--border); }
  .section-number { font-family: var(--mono); font-size: 1rem; color: var(--accent); opacity: 0.7; }
  .section-title { font-size: 0.85rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); }
  .section-body { padding: 16px; }

  .field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 16px; }
  .field { background: var(--surface); padding: 12px 14px; }
  .field.full { grid-column: span 2; }
  .field-label { font-family: var(--mono); font-size: 0.66rem; letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
  .field-value { font-size: 1.05rem; font-weight: 600; color: var(--text); word-break: break-word; }
  .field-value.mono { font-family: var(--mono); font-size: 0.76rem; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .data-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
  .data-table th { font-family: var(--mono); font-size: 0.66rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; font-weight: 400; }
  .data-table td { padding: 10px 10px; border-bottom: 1px solid var(--border); color: var(--text); vertical-align: middle; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: var(--surface2); }

  .badge { font-family: var(--mono); font-size: 0.66rem; letter-spacing: 0.1em; font-weight: 700; padding: 3px 8px; text-transform: uppercase; display: inline-block; }
  .badge-safe       { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
  .badge-hazard     { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .badge-unknown    { background: transparent; color: var(--warn);   border: 1px solid var(--warn); }
  .badge-conform    { background: var(--accent); color: #000; border: 1px solid var(--accent); }
  .badge-nonconform { background: var(--danger); color: #fff; border: 1px solid var(--danger); }

  .score-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .score-row:last-child { margin-bottom: 0; }
  .score-label { font-family: var(--mono); font-size: 0.72rem; color: var(--text-dim); width: 180px; flex-shrink: 0; letter-spacing: 0.05em; }
  .score-track { flex: 1; height: 4px; background: var(--border); position: relative; }
  .score-fill { height: 100%; transition: width 1s cubic-bezier(0.16, 1, 0.3, 1); }
  .score-fill-high { background: var(--accent); }
  .score-fill-mid  { background: var(--warn); }
  .score-fill-low  { background: var(--danger); }
  .score-value { font-family: var(--mono); font-size: 0.78rem; color: var(--text); width: 40px; text-align: right; flex-shrink: 0; }

  .claim-block { border: 1px solid var(--border); margin-bottom: 12px; }
  .claim-block:last-child { margin-bottom: 0; }
  .claim-top { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 14px; border-bottom: 1px solid var(--border); background: var(--surface2); }
  .claim-topic { font-family: var(--mono); font-size: 0.68rem; color: var(--accent); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 4px; }
  .claim-name { font-size: 1.05rem; font-weight: 700; color: var(--text); }
  .claim-name a { color: inherit; text-decoration: none; border-bottom: 1px solid var(--muted); }
  .claim-name a:hover { border-color: var(--accent); color: var(--accent); }

  .metric-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1px; background: var(--border); }
  .metric-block { background: var(--surface); padding: 12px 14px; }
  .metric-type { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 6px; }
  .metric-type-declared  { color: var(--accent); }
  .metric-type-criterion { color: #7c9ef8; }
  .metric-name-text { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; }
  .metric-val { font-family: var(--mono); font-size: 1.15rem; font-weight: 700; color: #fff; }
  .metric-unit { font-family: var(--mono); font-size: 0.72rem; color: var(--muted); margin-left: 4px; }
  .metric-link { display: block; margin-top: 8px; font-family: var(--mono); font-size: 0.66rem; color: var(--accent); text-decoration: none; letter-spacing: 0.08em; }
  .metric-link:hover { text-decoration: underline; }

  .trace-block { margin-bottom: 16px; }
  .trace-block:last-child { margin-bottom: 0; }

  .ext-link { font-family: var(--mono); font-size: 0.74rem; color: var(--accent); text-decoration: none; letter-spacing: 0.05em; border-bottom: 1px solid transparent; transition: border-color 0.15s; }
  .ext-link:hover { border-color: var(--accent); }

  @keyframes fadeDown { from { opacity: 0; transform: translateY(-12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeUp   { from { opacity: 0; transform: translateY(10px);  } to { opacity: 1; transform: translateY(0); } }

  .section:nth-child(1) { animation-delay: 0.05s; }
  .section:nth-child(2) { animation-delay: 0.10s; }
  .section:nth-child(3) { animation-delay: 0.15s; }
  .section:nth-child(4) { animation-delay: 0.20s; }
  .section:nth-child(5) { animation-delay: 0.25s; }
  .section:nth-child(6) { animation-delay: 0.30s; }
  .section:nth-child(7) { animation-delay: 0.35s; }
</style>

<div id="dpp-root"></div>

<script>
  // ── Helpers ────────────────────────────────────────────────────────────────

  function esc(v) {
    if (v === null || v === undefined) return '';
    return String(v)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function pct(v) { return Math.round((v || 0) * 100); }

  function scoreClass(v) {
    if (v >= 0.67) return 'score-fill-high';
    if (v >= 0.33) return 'score-fill-mid';
    return 'score-fill-low';
  }

  function scoreRow(label, value) {
    return `
      <div class="score-row">
        <span class="score-label">${label}</span>
        <div class="score-track">
          <div class="score-fill ${scoreClass(value)}" style="width:${pct(value)}%"></div>
        </div>
        <span class="score-value">${pct(value)}%</span>
      </div>`;
  }

  function field(label, value, opts = {}) {
    const cls = ['field', opts.full ? 'full' : '', opts.mono ? '' : ''].join(' ').trim();
    const valCls = 'field-value' + (opts.mono ? ' mono' : '');
    return `<div class="${cls}"><div class="field-label">${label}</div><div class="${valCls}">${value}</div></div>`;
  }

  function section(number, title, body, delay) {
    return `
      <div class="section" style="animation-delay:${delay}s">
        <div class="section-header">
          <span class="section-number">${String(number).padStart(2,'0')}</span>
          <span class="section-title">${title}</span>
        </div>
        <div class="section-body">${body}</div>
      </div>`;
  }

  function hazardBadge(m) {
    if (!('hazardous' in m)) return '<span class="badge badge-unknown">Unknown</span>';
    return m.hazardous
      ? '<span class="badge badge-hazard">Hazardous</span>'
      : '<span class="badge badge-safe">Safe</span>';
  }

  function extLink(url, label) {
    return `<a href="${esc(url)}" target="_blank" class="ext-link">${esc(label)} ↗</a>`;
  }

  // ── Section renderers ──────────────────────────────────────────────────────

  function renderIdentity(cs) {
    let html = `<div class="field-grid">
      ${field('Product name', esc(cs.name), { full: true })}
      ${field('Manufacturer', esc(cs.producedByParty?.name))}
      ${field('Country of production', esc(cs.countryOfProduction))}
      ${field('Production facility', esc(cs.producedAtFacility?.name))}
      ${cs.productionDate ? field('Production date', esc(cs.productionDate)) : ''}
      ${cs.batchNumber    ? field('Batch number',    esc(cs.batchNumber)) : ''}
      ${cs.serialNumber   ? field('Serial number',   esc(cs.serialNumber)) : ''}
      ${field('Credential ID', esc(cs.id), { full: true, mono: true })}
    </div>`;

    if (cs.description) {
      html += `<div style="font-size:0.95rem;color:var(--text-dim);line-height:1.6;padding:4px 2px;">${esc(cs.description)}</div>`;
    }

    return html;
  }

  function renderMaterials(cs) {
    if (!cs.materialsProvenance?.length) return '<p style="color:var(--muted);font-size:0.9rem;">No material data.</p>';

    const rows = cs.materialsProvenance.map(m => `
      <tr>
        <td>${esc(m.name)}</td>
        <td style="font-family:var(--mono);font-size:0.8rem;">${pct(m.massFraction)}%<br><span style="color:var(--muted);font-size:0.65rem;">${esc(m.massAmount?.value)} ${esc(m.massAmount?.unit)}</span></td>
        <td style="font-family:var(--mono);font-size:0.8rem;">${pct(m.recycledAmount)}%</td>
        <td>${hazardBadge(m)}</td>
        <td style="font-family:var(--mono);font-size:0.75rem;">${esc(m.originCountry)}</td>
      </tr>`).join('');

    return `
      <table class="data-table">
        <thead>
          <tr>
            <th>Material</th>
            <th>Mass fraction</th>
            <th>Recycled</th>
            <th>Hazard</th>
            <th>Origin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  function renderCircularity(cs) {
    let html = '';

    if (cs.circularityScorecard) {
      const sc = cs.circularityScorecard;
      if (sc.recycledContent)              html += scoreRow('Recycled content',      sc.recycledContent);
      if (sc.recyclableContent)            html += scoreRow('Recyclable content',    sc.recyclableContent);
      if (sc.materialCircularityIndicator) html += scoreRow('Circularity indicator', sc.materialCircularityIndicator);
      if (sc.utilityFactor) {
        html += `
          <div class="score-row" style="margin-top:12px;">
            <span class="score-label">Utility factor</span>
            <span style="font-family:var(--mono);font-size:0.85rem;color:var(--text);">${esc(sc.utilityFactor)}</span>
          </div>`;
      }
    }

    if (cs.dimensions && Object.keys(cs.dimensions).length) {
      html += `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
        <div class="field-grid">`;
      for (const [key, dim] of Object.entries(cs.dimensions)) {
        html += field(key, `<span style="font-family:var(--mono)">${esc(dim.value)} <span style="color:var(--muted);font-size:0.75rem;">${esc(dim.unit)}</span></span>`);
      }
      html += `</div></div>`;
    }

    if (!html) return '<p style="color:var(--muted);font-size:0.9rem;">No circularity data.</p>';
    return html;
  }

  function renderEmissions(cs) {
    if (!cs.emissionsScorecard) return '<p style="color:var(--muted);font-size:0.9rem;">No emissions data.</p>';
    const em = cs.emissionsScorecard;
    let html = `<div class="field-grid">`;

    if (em.carbonFootprint) {
      html += `<div class="field full">
        <div class="field-label">Carbon footprint</div>
        <div class="field-value" style="font-family:var(--mono);">
          <span style="font-size:1.8rem;color:var(--accent);">${esc(em.carbonFootprint)}</span>
          <span style="font-size:0.75rem;color:var(--muted);margin-left:6px;">kg CO2e / ${esc(em.declaredUnit)}</span>
        </div>
      </div>`;
    }

    if (em.operationalScope)    html += field('Operational scope',   esc(em.operationalScope));
    if (em.primarySourcedRatio) html += field('Primary data ratio',  `<span style="font-family:var(--mono)">${pct(em.primarySourcedRatio)}%</span>`);
    html += `</div>`;

    if (em.primarySourcedRatio) {
      html += `<div style="margin-top:12px;">` + scoreRow('Primary sourced ratio', em.primarySourcedRatio) + `</div>`;
    }

    if (em.reportingStandard) {
      html += `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
        <div class="field-label" style="margin-bottom:6px;">Reporting standard</div>
        ${extLink(em.reportingStandard.id, `${em.reportingStandard.name} (${em.reportingStandard.issueDate})`)}
      </div>`;
    }

    return html;
  }

  function renderConformity(cs) {
    if (!cs.conformityClaim?.length) return '<p style="color:var(--muted);font-size:0.9rem;">No conformity data.</p>';

    return cs.conformityClaim.map(claim => {
      const badge = claim.conformance
        ? '<span class="badge badge-conform">Conformant</span>'
        : '<span class="badge badge-nonconform">Non-conformant</span>';

      const metrics = (claim.declaredValue || []).map(m => `
        <div class="metric-block">
          <div class="metric-type metric-type-declared">Declared metric</div>
          <div class="metric-name-text">${esc(m.metricName)}</div>
          <div><span class="metric-val">${esc(m.metricValue?.value)}</span><span class="metric-unit">${esc(m.metricValue?.unit)}</span></div>
          ${claim.conformityEvidence?.linkURL
            ? `<a href="${esc(claim.conformityEvidence.linkURL)}" target="_blank" class="metric-link">${esc(claim.conformityEvidence.linkName || 'View evidence')} ↗</a>`
            : ''}
        </div>`).join('');

      const criteria = (claim.assessmentCriteria || []).flatMap(cr =>
        (cr.thresholdValue || []).map(t => `
          <div class="metric-block">
            <div class="metric-type metric-type-criterion">Assessment limit</div>
            <div class="metric-name-text">${esc(t.metricName)}</div>
            <div><span class="metric-val">${esc(t.metricValue?.value)}</span><span class="metric-unit">${esc(t.metricValue?.unit)}</span></div>
            ${cr.id ? `<a href="${esc(cr.id)}" target="_blank" class="metric-link">View criterion ↗</a>` : ''}
          </div>`)
      ).join('');

      return `
        <div class="claim-block">
          <div class="claim-top">
            <div>
              <div class="claim-topic">${esc(claim.conformityTopic)}</div>
              <div class="claim-name"><a href="${esc(claim.id)}" target="_blank">${esc(claim.referenceStandard?.name)}</a></div>
            </div>
            ${badge}
          </div>
          ${metrics || criteria
            ? `<div class="metric-grid">${metrics}${criteria}</div>`
            : ''}
        </div>`;
    }).join('');
  }

  function renderTraceability(cs) {
    if (!cs.traceabilityInformation?.length) return '<p style="color:var(--muted);font-size:0.9rem;">No traceability data.</p>';

    return cs.traceabilityInformation.map(trace => {
      const verifiedBar = trace.verifiedRatio != null
        ? `<div style="margin-bottom:14px;">${scoreRow('Verified ratio', trace.verifiedRatio)}</div>`
        : '';

      const rows = (trace.traceabilityEvent || []).map(ev => `
        <tr>
          <td>${esc(ev.linkName)}</td>
          <td>${extLink(ev.linkURL, 'View event')}</td>
        </tr>`).join('');

      return `
        <div class="trace-block">
          ${verifiedBar}
          <table class="data-table">
            <thead>
              <tr>
                <th>${esc(trace.valueChainProcess)}</th>
                <th>Event data</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }).join('');
  }

  // ── Bootstrap ──────────────────────────────────────────────────────────────

  try {
    const vcScript = document.querySelector('script[type="application/vc"]');
    if (!vcScript) throw new Error('No credential data block found.');

    const vc = JSON.parse(vcScript.textContent);
    const cs = vc.credentialSubject;

    const imgSrc = cs.productImage?.linkURL || null;

    document.getElementById('dpp-root').innerHTML = `
      <div class="dpp-header">
        <div>
          <div class="dpp-eyebrow">Digital Product Passport</div>
          <div class="dpp-title">${esc(cs.name)}</div>
          <div class="dpp-subtitle">${esc(cs.id)}</div>
        </div>
        ${imgSrc
          ? `<img src="${esc(imgSrc)}" class="dpp-image"
               onerror="this.onerror=null;this.style.display='none';"
               alt="Product">`
          : ''}
      </div>

      <div class="meta-strip">
        <div class="meta-cell">
          <div class="meta-cell-label">Manufacturer</div>
          <div class="meta-cell-value">${esc(cs.producedByParty?.name)}</div>
        </div>
        <div class="meta-cell">
          <div class="meta-cell-label">Facility</div>
          <div class="meta-cell-value">${esc(cs.producedAtFacility?.name)}</div>
        </div>
        <div class="meta-cell">
          <div class="meta-cell-label">Country</div>
          <div class="meta-cell-value">${esc(cs.countryOfProduction)}</div>
        </div>
        ${cs.productionDate ? `
        <div class="meta-cell">
          <div class="meta-cell-label">Produced</div>
          <div class="meta-cell-value">${esc(cs.productionDate)}</div>
        </div>` : ''}
      </div>

      ${section(1, 'Identity & Product Info',  renderIdentity(cs),      0.05)}
      ${section(2, 'Material Provenance',      renderMaterials(cs),     0.10)}
      ${section(3, 'Circularity & Dimensions', renderCircularity(cs),   0.15)}
      ${section(4, 'Emissions',                renderEmissions(cs),     0.20)}
      ${section(5, 'Conformity Declarations',  renderConformity(cs),    0.25)}
      ${section(6, 'Traceability',             renderTraceability(cs),  0.30)}
    `;

  } catch (err) {
    document.getElementById('dpp-root').innerHTML =
      `<div style="color:#ff3d5a;padding:20px;font-family:monospace;">Error: ${esc(err.message)}</div>`;
  }
</script>

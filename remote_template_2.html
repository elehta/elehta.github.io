<style>
  :root { --font-main: 'Inter', -apple-system, sans-serif; --font-mono: 'JetBrains Mono', 'Fira Code', monospace; --radius: 12px; --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --dpp-primary: #10b981; --dcc-primary: #3b82f6; --dia-primary: #64748b; }
  #dpp-root { width: 100%; display: flex; justify-content: center; }
  .verified-badge, .safe-badge, .score-high { background: var(--dpp-primary); }
  .revoked-badge, .hazardous-badge, .score-low { background: #ef4444; }
  .unknown-badge, .score-mid { background: #f59e0b; }
  .card-viewer { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; max-width: 900px; padding: 10px; box-sizing: border-box; }
  .credential-card { font-family: var(--font-main); width: 100%; max-width: 640px; min-width: 280px; margin: 0 auto; background: #ffffff; border-radius: var(--radius); border: 1px solid #e5e7eb; box-shadow: var(--shadow); overflow: hidden; position: relative; transition: transform 0.2s ease; flex-shrink: 1; flex-grow: 0; box-sizing: border-box; }
  .credential-header { padding: 16px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f3f4f6; }
  .item-dpp .credential-header::before { content: '♻️'; font-size: 2.25rem; }
  .credential-body { padding: 20px; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; min-width: 0; }
  .data-row { display: flex; align-items: baseline; margin-bottom: 18px; font-size: 1.12rem; width: 100%; }
  .label { flex: 0 0 30%; color: #6b7280; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.05em; text-align: left; line-height: 1.5; }
  .value { flex: 0 0 70%; font-weight: 600; color: #111827; text-align: right; padding-right: 15px; line-height: 1.5; white-space: normal; overflow-wrap: break-word; min-width: 0; }
  .item-dpp { border-top: 4px solid var(--dpp-primary); }
  .item-dpp .credential-header { background: linear-gradient(to top, #ffffff, #dfebe1); }
  .badge { color: #ffffff; font-weight: 700; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; }
  .topic-group { margin-top: 15px; background: #f4f4f4; border-radius: 8px; padding: 12px; border: 1px solid #f3f4f6; }
  .topic-header { display: flex; align-items: baseline; gap: 6px; font-size: 0.95rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #374151; margin-bottom: 15px; }
  .larger { font-size: 1.25rem; font-weight: 700; }
  .item-dpp .topic-header { border-left: 3px solid var(--dpp-primary); padding-left: 8px; }
  .topic-group .data-row { margin-bottom: 15px; }
  .topic-group .data-row:last-child { margin-bottom: 0; }
  .topic-group table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; line-height: 1.4; }
  .topic-group th { text-align: left; padding: 8px 4px; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-weight: 500; text-transform: uppercase; font-size: 0.95rem; letter-spacing: 0.05em; }
  .topic-group td { padding: 8px 4px; border-bottom: 1px solid #f3f4f6; color: #111827; }
  .topic-group tr:last-child td { border-bottom: none; }
  .topic-group td:first-child { font-weight: 500; color: #374151; }
  .topic-media img { width: 100%; max-height: 300px; object-fit: cover; margin-bottom: 12px; }
  .score-container { display: flex; flex-direction: column; align-items: flex-end; width: 100%; margin-top: 2px; margin-bottom: 2px; }
  .score-track { width: 30%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; position: relative; }
  .score-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-in-out; }
  .external-link { color: var(--dpp-primary); text-decoration: none; font-weight: 500; font-size: 0.85rem; padding: 2px 6px; border-radius: 4px; display: inline; line-height: 1.8; transition: all 0.2s ease; box-decoration-break: clone; -webkit-box-decoration-break: clone; }
  .external-link:hover { background: #dcfce7; color: #065f46; }
  .external-link::after { content: '\00a0↗'; font-weight: bold; white-space: nowrap; }
  .data-row.nested { margin-left: 15px; }
  .data-row.nested .label { flex: 0 0 calc(40% - 25px); font-size: 0.9rem; }
  .data-row.nested .value { flex: 0 0 60%; font-size: 1.12rem; font-weight: 500; }
  .truncate-row { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%; }
  .claim-info { flex: 1; }
  .status-container { text-align: right; flex-shrink: 0; }
  .topic-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; }
  .standard-name { font-weight: 700; color: #111827; font-size: 1rem; line-height: 1.2; }
  .metric-name { font-weight: 600; font-size: 0.85rem; }
  .metric-val { font-size: 1rem; }
  .primary-label { color: var(--dpp-primary); }
  .criterion-pill { border-left: 3px solid var(--dcc-primary); }
  .criterion-label { color: var(--dcc-primary); }
  .criterion-link { color: var(--dcc-primary); }
  .claim-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
  .claim-meta { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px dashed #d1d5db; padding-bottom: 8px; }
  .nested-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
  .metric-pill { background: #ffffff; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; font-size: 0.8rem; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
  .metric-label { font-weight: 700; text-transform: uppercase; font-size: 0.7rem; margin-bottom: 4px; }
  .pill-link { margin-top: 8px; padding: 4px 0; border-top: 1px solid #f3f4f6; color: var(--dpp-primary); text-decoration: none; font-size: 0.75rem; font-weight: 600; display: block; }
</style>

<div id="dpp-root" class="card-viewer"></div>

<script>
(function () {

  // ── Helpers ────────────────────────────────────────────────────────────────

  function esc(val) {
    if (val == null) return '';
    return String(val)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function pct(val) {
    return (val * 100).toFixed(1).replace(/\.0$/, '');
  }

  function scoreClass(val) {
    if (val >= 0.67) return 'score-high';
    if (val >= 0.33) return 'score-mid';
    return 'score-low';
  }

  function scoreBar(val) {
    return `
      <div class="score-track">
        <div class="score-fill ${scoreClass(val)}" style="width:${pct(val)}%"></div>
      </div>`;
  }

  function hazardBadge(material) {
    if (!('hazardous' in material)) {
      return '<span class="badge unknown-badge">UNKNOWN</span>';
    }
    return material.hazardous
      ? '<span class="badge hazardous-badge">HAZARDOUS</span>'
      : '<span class="badge safe-badge">SAFE</span>';
  }

  function extLink(href, label) {
    return `<a href="${esc(href)}" target="_blank" class="external-link">${esc(label)}</a>`;
  }

  function dataRow(label, valueHtml, nested) {
    return `
      <div class="data-row${nested ? ' nested' : ''}">
        <span class="label">${esc(label)}</span>
        <span class="value">${valueHtml}</span>
      </div>`;
  }

  function scoreRow(label, val) {
    return `
      <div class="data-row">
        <span class="label">${esc(label)}</span>
        <div class="value score-container">
          <span>${pct(val)}%</span>
          ${scoreBar(val)}
        </div>
      </div>`;
  }

  // ── Read credential from embedded data block ───────────────────────────────

  const vcScript = document.querySelector('script[type="application/vc"]');
  if (!vcScript) {
    document.getElementById('dpp-root').innerHTML =
      '<div class="error">No credential data found.</div>';
    return;
  }

  let vc;
  try {
    vc = JSON.parse(vcScript.textContent);
  } catch (e) {
    document.getElementById('dpp-root').innerHTML =
      '<div class="error">Invalid credential data.</div>';
    return;
  }

  const cs = vc.credentialSubject || {};

  // ── Section builders ───────────────────────────────────────────────────────

  function buildIdentity() {
    const imgSrc = cs.productImage && cs.productImage.linkURL
      ? esc(cs.productImage.linkURL)
      : 'https://placehold.co/200x150';

    let html = `
      <div class="topic-group">
        <div class="topic-header"><span class="larger">${esc(cs.name)}</span></div>
        <div class="topic-media">
          <img src="${imgSrc}"
            onerror="this.onerror=null;this.src='https://placehold.co/200x150';"
            alt="Product Image" class="product-main-img">
        </div>
        ${dataRow('Product', esc(cs.name))}
        ${dataRow('Manufacturer', esc(cs.producedByParty && cs.producedByParty.name))}
        ${dataRow('Production location',
          esc((cs.producedAtFacility && cs.producedAtFacility.name) || '') +
          (cs.countryOfProduction ? ` (${esc(cs.countryOfProduction)})` : '')
        )}
        ${dataRow('Description', esc(cs.description))}
        ${dataRow('DPP ID', `<span class="truncate-row">${esc(cs.id)}</span>`)}
        ${cs.batchNumber    ? dataRow('Batch number',    esc(cs.batchNumber))    : ''}
        ${cs.serialNumber   ? dataRow('Serial number',   esc(cs.serialNumber))   : ''}
        ${cs.productionDate ? dataRow('Production date', esc(cs.productionDate)) : ''}`;

    if (cs.dimensions && typeof cs.dimensions === 'object') {
      html += `<div class="data-row"><span class="label">Dimensions</span></div>`;
      for (const [key, dim] of Object.entries(cs.dimensions)) {
        html += `
          <div class="data-row nested">
            <span class="label">${esc(key)}</span>
            <span class="value"><strong>${esc(dim.value)}</strong> ${esc(dim.unit)}</span>
          </div>`;
      }
    }

    html += `</div>`;
    return html;
  }

  function buildMaterials() {
    const rows = (cs.materialsProvenance || []).map(m => `
      <tr>
        <td>${esc(m.name)}</td>
        <td>${pct(m.massFraction)}% (${esc(m.massAmount && m.massAmount.value)} ${esc(m.massAmount && m.massAmount.unit)})</td>
        <td>${pct(m.recycledAmount)}%</td>
        <td>${hazardBadge(m)}</td>
        <td>${esc(m.originCountry)}</td>
      </tr>`).join('');

    return `
      <div class="topic-group">
        <div class="topic-header">Material Provenance</div>
        <table>
          <thead>
            <tr>
              <th>Material</th><th>Mass fraction</th><th>Recycled</th>
              <th>Hazardousity</th><th>Origin</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }

  function buildCircularityScorecard() {
    const sc = cs.circularityScorecard;
    if (!sc) return '';

    let html = `<div class="topic-group"><div class="topic-header">Circularity Scorecard</div>`;
    if (sc.recycledContent    != null) html += scoreRow('Recycled content',     sc.recycledContent);
    if (sc.recyclableContent  != null) html += scoreRow('Recyclable content',   sc.recyclableContent);
    if (sc.materialCircularityIndicator != null)
      html += scoreRow('Circularity indicator', sc.materialCircularityIndicator);
    if (sc.utilityFactor      != null) html += dataRow('Utility factor', esc(sc.utilityFactor));
    html += `</div>`;
    return html;
  }

  function buildCircularity() {
    return `
      <div class="topic-group">
        <div class="topic-header">Circularity</div>
        <div class="data-row">
          <span class="label">Recyclability Score</span>
          <div class="value score-container">
            <span>6.5 / 10</span>
            <div class="score-track"><div class="score-fill score-mid" style="width:65%"></div></div>
          </div>
        </div>
        <div class="data-row">
          <span class="label">Repair Score</span>
          <div class="value score-container">
            <span>8.5 / 10</span>
            <div class="score-track"><div class="score-fill score-high" style="width:85%"></div></div>
          </div>
        </div>
        <div class="data-row">
          <span class="label">Carbon Footprint</span>
          <div class="value score-container">
            <span>3.2 / 10</span>
            <div class="score-track"><div class="score-fill score-low" style="width:32%"></div></div>
          </div>
        </div>
        ${dataRow('Recycling information', extLink('https://example.com/Recycling_information.pdf', 'Recycling_information.pdf'))}
        ${dataRow('Repair information',    extLink('https://example.com/Repair_information.pdf',    'Repair_guide.pdf'))}
      </div>`;
  }

  function buildEmissions() {
    const em = cs.emissionsScorecard;
    if (!em) return '';

    let html = `<div class="topic-group"><div class="topic-header">Emissions Scorecard</div>`;

    if (em.carbonFootprint != null) {
      html += `
        <div class="data-row">
          <span class="label">Carbon Footprint</span>
          <span class="value larger" style="color:#374151;">
            ${esc(em.carbonFootprint)}
            <span style="font-size:0.85rem;font-weight:500;">kg CO2e / ${esc(em.declaredUnit)}</span>
          </span>
        </div>`;
    }
    if (em.operationalScope)    html += dataRow('Scope', esc(em.operationalScope));
    if (em.primarySourcedRatio != null) html += scoreRow('Primary Data Ratio', em.primarySourcedRatio);

    if (em.reportingStandard) {
      html += `
        <div class="data-row" style="margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;">
          <span class="label">Reporting Standard</span>
          <span class="value">
            ${extLink(em.reportingStandard.id,
              `${em.reportingStandard.name} (${em.reportingStandard.issueDate})`)}
          </span>
        </div>`;
    }

    html += `</div>`;
    return html;
  }

  function buildConformity() {
    const claims = cs.conformityClaim;
    if (!claims || !claims.length) return '';

    const cards = claims.map(claim => {
      const conformanceBadge = claim.conformance
        ? '<span class="badge safe-badge">CONFORMANT</span>'
        : '<span class="badge revoked-badge">NON-CONFORMANT</span>';

      const declaredMetrics = (claim.declaredValue || []).map(metric => {
        const evidenceLink = claim.conformityEvidence && claim.conformityEvidence.linkURL
          ? `<a href="${esc(claim.conformityEvidence.linkURL)}" target="_blank" class="pill-link">
               ${esc(claim.conformityEvidence.linkName || 'View Evidence')} ↗
             </a>`
          : '';
        return `
          <div class="metric-pill">
            <div class="metric-details">
              <span class="metric-label primary-label">Declared Metric</span>
              <div class="metric-name">${esc(metric.metricName)}</div>
              <div class="metric-val"><strong>${esc(metric.metricValue && metric.metricValue.value)}</strong> ${esc(metric.metricValue && metric.metricValue.unit)}</div>
            </div>
            ${evidenceLink}
          </div>`;
      }).join('');

      const thresholdMetrics = (claim.assessmentCriteria || []).flatMap(criterion =>
        (criterion.thresholdValue || []).map(threshold => `
          <div class="metric-pill criterion-pill">
            <div class="metric-details">
              <span class="metric-label criterion-label">Assessment Limit</span>
              <div class="metric-name">${esc(threshold.metricName)}</div>
              <div class="metric-val"><strong>${esc(threshold.metricValue && threshold.metricValue.value)}</strong> ${esc(threshold.metricValue && threshold.metricValue.unit)}</div>
            </div>
            ${criterion.id
              ? `<a href="${esc(criterion.id)}" target="_blank" class="pill-link criterion-link">View Criterion Reference ↗</a>`
              : ''}
          </div>`)
      ).join('');

      return `
        <div class="claim-card">
          <div class="claim-meta">
            <div class="claim-info">
              <div class="topic-label">${esc(claim.conformityTopic)}</div>
              <div class="standard-name">
                <a href="${esc(claim.id)}">${esc(claim.referenceStandard && claim.referenceStandard.name)}</a>
              </div>
            </div>
            <div class="status-container">${conformanceBadge}</div>
          </div>
          <div class="nested-metrics">${declaredMetrics}${thresholdMetrics}</div>
        </div>`;
    }).join('');

    return `
      <div class="topic-group">
        <div class="topic-header">Conformity Declarations</div>
        ${cards}
      </div>`;
  }

  function buildTraceability() {
    const info = cs.traceabilityInformation;
    if (!info || !info.length) return '';

    const sections = info.map(trace => {
      const verifiedRow = trace.verifiedRatio != null ? `
        <div class="data-row">
          <span class="label">Verified Ratio</span>
          <div class="value score-container">
            <span>${pct(trace.verifiedRatio)}%</span>
            <div class="score-track">
              <div class="score-fill verified-badge" style="width:${pct(trace.verifiedRatio)}%"></div>
            </div>
          </div>
        </div>` : '';

      const eventRows = (trace.traceabilityEvent || []).map(ev => `
        <tr>
          <td style="font-weight:500;">${esc(ev.linkName)}</td>
          <td style="text-align:right;">${extLink(ev.linkURL, 'View Event')}</td>
        </tr>`).join('');

      return `
        ${verifiedRow}
        <table>
          <thead>
            <tr>
              <th>${esc(trace.valueChainProcess)}</th>
              <th style="text-align:right;">Event Data</th>
            </tr>
          </thead>
          <tbody>${eventRows}</tbody>
        </table>`;
    }).join('');

    return `
      <div class="topic-group">
        <div class="topic-header">Traceability Events</div>
        ${sections}
      </div>`;
  }

  // ── Assemble and render ────────────────────────────────────────────────────

  document.getElementById('dpp-root').innerHTML = `
    <article class="credential-card item-dpp">
      <div class="credential-header">
        <strong>DIGITAL PRODUCT PASSPORT</strong>
      </div>
      <div class="credential-body">
        ${buildIdentity()}
        ${buildMaterials()}
        ${buildCircularityScorecard()}
        ${buildCircularity()}
        ${buildEmissions()}
        ${buildConformity()}
        ${buildTraceability()}
      </div>
    </article>`;

  // Notify host page of the rendered height
function reportHeight() {
  const height = document.getElementById('dpp-root').scrollHeight;
  window.parent.postMessage({ type: 'vc-render-height', height }, '*');
}

// Report after render, and again after images load
reportHeight();
window.addEventListener('load', reportHeight);
  
})();
</script>


<!doctype html>
<!--
Copyright 2016 Google Inc. All Rights Reserved.

-->
<html>
  <head>
    <title>Bluetooth Rename Tool</title>
    <meta name="description" content="Rename a Bluetooth Smart device with Web Bluetooth.">

    <meta charset="utf-8">
 </head>
 
 <body>

 <div id="cards">
      <paper-card heading="Bluetooth Rename Tool">
        <div class="card-content">
          <paper-progress id="progress" indeterminate hidden="true"></paper-progress>
        </div>
      </paper-card>

      <paper-card>
        <div class="card-content">
          <paper-button id="connectButton" raised class="colorful">Connect</paper-button>
        </div>
      </paper-card>

      <paper-card>
        <div class="card-content">
          <paper-input id="nameInput" label="Device Name" disabled></paper-input>
          <paper-button id="writeNameButton" class="colorful" disabled>Update Name</paper-button>
        </div>
      </paper-card>

      <paper-dialog id="errorDialog">
        <h2>Error</h2>
        <p id="dialogError">Could not connect to bluetooth device!</p>
      </paper-dialog>

      <paper-dialog id="doneDialog">
        <h2>Done!</h2>
      </paper-dialog>
    </div>

<script>
      "use strict";
      document.addEventListener('WebComponentsReady', function() {
        function logProgress(x) {
          console.log("Progress:", x);
          return x;
        }
        function handleError(error) {
          console.log(error);
          if (error.toString().match(/User cancelled/))
            return;  // User didn't make a choice, no error needed.
          else
            dialogError.innerText = error;
          errorDialog.open();
        }
        function disableInput() {
          nameInput.disabled = true;
          nameInput.charCounter = false;
          writeNameButton.disabled = true;
        }
        function enableInput() {
          nameInput.disabled = false;
          nameInput.charCounter = true;
          writeNameButton.disabled = false;
        }
        function anyDeviceFilter() {
          // This is the closest we can get for now to get all devices.
          // https://github.com/WebBluetoothCG/web-bluetooth/issues/234
          return Array.from('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ')
              .map(c => ({namePrefix: c}))
              .concat({name: ''});
        }
        connectButton.addEventListener('click', function () {
          progress.hidden = false;
          disableInput();
          Promise.resolve()
          .then(_ => {
            if (!navigator.bluetooth)
              throw "No Web Bluetooth support.";
            return navigator.bluetooth.requestDevice({
              filters: anyDeviceFilter(),
              optionalServices: ['generic_access']
            })
          })
          .then(logProgress)
          .then(device => {
            nameInput.value = "";
            return device.gatt.connect().catch(error => {
              logProgress(error);
              throw "Unable to connect. Some devices refuse connections.";
            });
          })
          .then(logProgress)
          .then(server => server.getPrimaryService("generic_access"))
          .then(logProgress)
          .then(service => service.getCharacteristic("gap.device_name"))
          .then(logProgress)
          .then(characteristic => {
            window.deviceName = characteristic;
            return characteristic.readValue();
          })
          .then(logProgress)
          .then(value => {
            window.value = value;
            nameInput.value = new TextDecoder("utf-8").decode(value);
            if (window.deviceName.properties.write)
              enableInput();
            else
              throw "Name is not writable on this device.";
          })
          .catch(handleError)
          .then(_ => progress.hidden = true)
        });
        writeNameButton.addEventListener('click', function () {
          progress.hidden = false;
          Promise.resolve()
          .then(_ => {
            let uint8arrayName = new TextEncoder("utf-8").encode(nameInput.value);
            console.log("Writing: ", uint8arrayName);
            return deviceName.writeValue(uint8arrayName)
          })
          .then(logProgress)
          .then(_ => doneDialog.open())
          .catch(handleError)
          .then(_ => progress.hidden = true)
        });
      });
    </script>
	
	  </body>
</html>